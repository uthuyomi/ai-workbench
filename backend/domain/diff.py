# backend/domain/diff.py
"""
Diff ドメインモデル定義

このファイルは、ai-workbench Backend における
「Diff（差分）」という概念を定義する。

Diff とは:
- Backend が生成する「唯一の変更成果物」
- 実装結果ではなく「変更前／変更後の差」を表す
- 人間のレビューと承認を前提にした中間表現

最重要原則:
- Diff は常に Full Replace（全文置換）
- 行単位・部分適用・自動マージは行わない
- Diff 自体が判断結果の“説明可能な証拠”となる

この原則が崩れると、
変更理由の追跡性・可逆性・安全性が失われる。
"""

from __future__ import annotations

from typing import List

from pydantic import BaseModel, Field


# ============================================================
# DiffFile
# ============================================================
class DiffFile(BaseModel):
    """
    単一ファイルに対する差分定義。

    このモデルは、
    - どのファイルが
    - どの内容から
    - どの内容へ

    変更されるのかを、明示的に表現する。

    注意:
    - 部分差分（hunk）を持たせてはいけない
    - 行番号情報を持たせてはいけない
    - 自動適用前提の構造にしてはいけない
    """

    # 変更対象ファイルのパス（Workspace ルートからの相対パス）
    path: str = Field(min_length=1)

    # 変更前の全文
    #
    # - 空文字は「新規作成」を意味しうる
    # - 実ファイルの現状をそのまま入れる
    before: str = Field(min_length=0)

    # 変更後の全文
    #
    # - 人間がレビューする最終形
    # - Backend が「これを提案している」という明確な意思表示
    after: str = Field(min_length=0)

    # --------------------------------------------------------
    # Pydantic 設定
    # --------------------------------------------------------
    model_config = {
        # 想定外フィールドの混入を防止
        "extra": "forbid",

        # DiffFile は変更提案そのものなので不変とする
        # 修正が必要な場合は Diff を作り直す
        "frozen": True,
    }


# ============================================================
# Diff
# ============================================================
class Diff(BaseModel):
    """
    Diff 全体を表すモデル。

    このモデルは、
    - 複数ファイルにまたがる変更提案
    - Backend が生成した「判断結果の集合」

    を表現する。

    注意:
    - Diff は実行結果ではない
    - Diff は適用を保証しない
    - Diff は人間の承認を前提とする
    """

    # 紐づく Project ID
    #
    # Diff は必ず Project 単位で生成される
    project_id: str = Field(min_length=1)

    # 差分を含むファイル一覧
    #
    # 注意:
    # - 順序に意味はない
    # - 適用順序を表現してはいけない
    files: List[DiffFile] = Field(default_factory=list)

    # --------------------------------------------------------
    # Pydantic 設定
    # --------------------------------------------------------
    model_config = {
        # フィールド肥大化を防止
        "extra": "forbid",

        # Diff はスナップショット的成果物
        # → 書き換えず、再生成する
        "frozen": True,
    }


# ============================================================
# export 制御
# ============================================================
# 外部に公開するシンボルを限定し、責務境界を固定する
__all__ = [
    "DiffFile",
    "Diff",
]
